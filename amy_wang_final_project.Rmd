---
title: "final_assignment"
output: pdf_document
date: "2024-08-13"
---

```{r}
library(pheatmap)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(rlang)
library(corrplot)
install.packages("table1")
library(table1)
```

```{r}

#---------------------------INITIALIZING DATA-------------------------
datafiles <- list.files(path = "/Users/amyw/Documents/QBS103/DSProject", pattern = ".csv")
print(datafiles)

setwd("/Users/amyw/Documents/QBS103/DSProject")

for (file in datafiles){
  the_file <- read.csv(file)
}
  
setwd("/Users/amyw/Documents/QBS103/DSProject")

gene_df <- read.csv('QBS103_GSE157103_genes.csv', header = TRUE,row.names = 1)
meta_df <- read.csv('QBS103_GSE157103_series_matrix.csv', header = TRUE, row.names = 1)

working_genes <- as.data.frame(t(gene_df)) #pivoting dataframe to select AAGAB as a column
#print(head(working_genes))

new_comp <- merge(working_genes, meta_df, by = 'row.names') #merging the two dataframes using the row names
final_comp <- data.frame(new_comp, row.names = 1) #renaming the row names as the participant ID
#print(head(final_comp))


```

```{r}
#-----------------------SEPARATING BY CAT VARIABLE------------------------
ventData <- data.frame(final_comp[final_comp$mechanical_ventilation == ' yes', ])
ventData
nonventData <- data.frame(final_comp[final_comp$mechanical_ventilation == ' no', ])
nonventData
```



```{r}
#---------------------------PART 1: DISTRIBUTION---------------------------
#getting index numbers for continuous variables
contVars <- c('age', 'lactate.mmol.l.', 'fibrinogen')
contVarsIndex <- list()

for (i in 1:length(final_comp)) {
  for (j in 1:length(contVars)) {
    if (colnames(final_comp)[i] == contVars[j])
      print(paste('Index for', contVars[j] ,'is', i))
      contVarsIndex <- append(contVarsIndex, i)
    }
}
contVarsIndex = c(110, 122, 123)

```

```{r}
#-----------------------------CHECKING DISTRIBUTION--------------------
for (index in contVarsIndex){
  #checking distribution
  xAxis = 0
  
  if (colnames(final_comp[index]) == 'age'){
    xAxis <- 'Age'
    # print(xAxis)
  }

  else if (colnames(final_comp[index]) == 'lactate.mmol.l.'){
    xAxis <- 'Lactate (mmol/l)'
    # print(xAxis)
  }
  else {#(colnames(final_comp[index]) == 'fibrinogen'){
    xAxis <- 'Fibrinogen'
    # print(xAxis)
  }

  final_comp[[index]]<- as.numeric(final_comp[[index]])
  
  plot<- ggplot(data = final_comp,aes(x = final_comp[[index]])) +
                geom_histogram() + 
                labs(x = xAxis, y = 'Frequency') +
                theme_classic()
  print(plot)

}
```

```{r}
#-----------------PART 1: VALUES FOR CONT VAR FOR VENTILATED PATIENTS--------------

#lactate non uniformly distributed

medVar <- median(ventData$lactate.mmol.l., na.rm = TRUE)
# Quartile values
quantileVar <- quantile(ventData[122], na.rm = TRUE)
  
# IQR (Q3 - Q1)
IQRVar <- IQR(ventData$lactate.mmol.l., na.rm = TRUE)
  
lowerQua <- quantile(ventData$lactate.mmol.l., 1/4, na.rm = TRUE)
  
higherQua <- quantile(ventData$lactate.mmol.l., 3/4, na.rm = TRUE)
  
#print median and IQR statement
print(paste('Median [IQR] of lactate of age in ventilated patients:',round((medVar),digits = 2),
             '[',round((lowerQua), digits = 2), ',', round((higherQua), digits = 2),']'))


#for age and fibrinogen which are uniformly distributed

print(paste('Mean (sd) of age in ventilated patients: ',round(mean(ventData$age),digits = 2),' (',
             round(sd(ventData$age),digits = 2),')'))


print(paste('Mean (sd) of fibrinogen in ventilated patients: ',round(mean(ventData$fibrinogen, na.rm=TRUE),digits = 2),' (',
             round(sd(ventData$fibrinogen, na.rm=TRUE),digits = 2),')'))

```


```{r}
#-----------------PART 1: VALUES FOR CONT VAR FOR NONVENTILATED PATIENTS--------------

#lactate non uniformly distributed

medVar <- median(nonventData$lactate.mmol.l., na.rm = TRUE)
# Quartile values
quantileVar <- quantile(nonventData[122], na.rm = TRUE)
  
# IQR (Q3 - Q1)
IQRVar <- IQR(nonventData$lactate.mmol.l., na.rm = TRUE)
  
lowerQua <- quantile(nonventData$lactate.mmol.l., 1/4, na.rm = TRUE)
  
higherQua <- quantile(nonventData$lactate.mmol.l., 3/4, na.rm = TRUE)
  
#print median and IQR statement
print(paste('Median [IQR] of lactate in non-ventilated patients:',round((medVar),digits = 2),
             '[',round((lowerQua), digits = 2), ',', round((higherQua), digits = 2),']'))


#for age and fibrinogen which are uniformly distributed

print(paste('Mean (sd) of age in non-ventilated patients: ',round(mean(nonventData$age, na.rm=TRUE),digits = 2),' (',
             round(sd(nonventData$age, na.rm=TRUE),digits = 2),')'))

print(paste('Mean (sd) of fibrinogen in non-ventilated patients: ',round(mean(nonventData$fibrinogen, na.rm=TRUE),digits = 2),' (',
             round(sd(nonventData$fibrinogen, na.rm=TRUE),digits = 2),')'))

```

```{r}
#-------------------PART 1: CATEGORICAL DATA---------------------------------

print(length(ventData$sex))
data.frame('n' = c(table(ventData$sex)),
          'perc' = c(round(table(ventData$sex)/(length(ventData$sex))*100,digits = 2)))


data.frame('n' = c(table(nonventData$sex)),
          'perc' = c(round(table(nonventData$sex)/(length(nonventData$sex))*100,digits = 2)))

#--------------- PART 1: for ICU status------------------------
data.frame('n' = c(table(ventData$icu_status)),
          'perc' = c(round(table(ventData$icu_status)/(length(ventData$icu_status))*100,digits = 2)))


data.frame('n' = c(table(nonventData$icu_status)),
          'perc' = c(round(table(nonventData$icu_status)/(length(nonventData$icu_status))*100,digits = 2)))
```

```{r}

#+++++++++++++++++++trying table1 package
#+


table1Data <- data.frame(final_comp$mechanical_ventilation, 
                         final_comp$lactate.mmol.l., 
                         final_comp$age, 
                         final_comp$fibrinogen,
                         final_comp$sex, #categorical
                         final_comp$icu_status) #categorical
head(table1Data)

# #factoring categorical data
# table1Data$final_comp.sex <- 
#   factor(table1Data$final_comp.sex, 
#          #levels=c(male, female, unknown),
#          labels=c("Male", # Reference
#                   "Female", 
#                   "Unk"))


table1Data$final_comp.mechanical_ventilation <- 
  factor(table1Data$final_comp.mechanical_ventilation, 
         levels=c(' no',' yes'),
         labels=c("No Mechanical Ventilation", # Reference
                  "Mechanical Ventilation"))

table1Data$final_comp.sex <- 
  factor(table1Data$final_comp.sex, 
         levels=c('female','male', missing),
         labels=c("Female", # Reference
                  "Male",
                  "Missing"))



table1(~final_comp.age + 
         final_comp.sex + 
         final_comp.lactate.mmol.l.+ 
         final_comp.fibrinogen +
         final_comp.sex +
         final_comp.icu_status | final_comp.mechanical_ventilation, data=table1Data)

```



```{r}
#----------------------------PART 2: HISTOGRAM OF AAGAB--------------------------
#plotting histogram of AAGAB
working_genes <- as.data.frame(t(gene_df)) #pivoting dataframe to select AAGAB as a column
print(head(working_genes))

ggplot(working_genes, aes(x=AAGAB))+
  geom_histogram(binwidth = 5, boundary = 0)+ #boundary at 0 to group data
  labs(title = 'Distribution of AAGAB', x = 'Expression of AAGAB', y = 'Frequency')+
  theme_light()+
  theme(plot.title = element_text(hjust=0.5))

new_comp <- merge(working_genes, meta_df, by = 'row.names') #merging the two dataframes using the row names
final_comp <- data.frame(new_comp, row.names = 1) #renaming the row names as the participant ID
print(head(final_comp))


final_comp$age<- as.numeric(final_comp$age) #converting the age column from characters to numerics


#--------------------------PART 2: SCATTERPLOT OF AAGAB--------------------------
ggplot(final_comp, aes(x= age, y=AAGAB))+
  geom_point()+ #two age unknowns from the data
  labs(title = 'Age compared to distribution of gene AAGAB', 
       x = 'Age (years)', y = 'Expression of AAGAB')+
  scale_x_continuous(breaks=seq(0,150,by=10))+
  theme_light()+
  theme(plot.title = element_text(hjust=0.5))


box_first <- dplyr::select(final_comp,AAGAB, sex, mechanical_ventilation) #selecting data columns for easier viewing
#print(box_first)

#----------------------------PART 2: BOXPLOT OF AAGAB--------------------------

box_long <- box_first %>% #pivoting long to prep for boxplot
  tidyr::pivot_longer(cols= c(sex, mechanical_ventilation), 
                      names_to = 'categorical', values_to = 'Sex/MechVent')
head(box_long)

ggplot(box_first, aes (sex, AAGAB, fill = mechanical_ventilation))+
  geom_boxplot()+
  theme_light()+
  labs(title = 'Distribution of AAGAB Based on Sex Coloured by Mechanical Ventilation', 
       x = 'Sex', y = 'Expression of AAGAB')+
  theme(plot.title = element_text(hjust=0))+
  scale_fill_discrete(name = 'Mechanical Ventilation Status')+
  scale_x_discrete(labels = c('Female', 'Male', 'Unknown'))
```


```{r}
#------------------------------PART 3: HEATMAP

# #generating variance values
# geneVariance <- apply(final_comp, MARGIN = 2, FUN = var, )
# 
# #ordering rows of genes in order of decreasing variance
# geneVariance <- final_comp[order(geneVariance,decreasing = T),]


# Define covariates for tracking bar

annotationData <- data.frame(sex = final_comp$sex,icu_status = final_comp$icu_status)
unique(annotationData$icu_status)

rownames(annotationData) <- rownames(final_comp)

annotationColors <- list(sex= c(' male' = 'aquamarine4',
                                   ' female' = 'purple4',
                                   ' unknown' = 'red'),
                            icu_status = c(' yes' = 'yellow',
                                           ' no' = 'pink'))

f2 <-data.frame(final_comp[,15:25])
rownames(f2) = rownames(final_comp)
# Generate heatmap
pheatmap(f2,
         show_rownames = F,
         cluster_rows = T,
         cluster_cols = T,
         annotation_row = annotationData,
         annotation_colors = annotationColors)


```


