---
title: "final_assignment"
output: pdf_document
date: "2024-08-13"
---

```{r}
library(pheatmap)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(rlang)
library(corrplot)
install.packages("table1")
library(table1)
# install.packages(tableone)
# library(tableone)
```

```{r}
#---------------------------INITIALIZING DATA-------------------------
datafiles <- list.files(path = "/Users/amyw/Documents/QBS103/DSProject", pattern = ".csv")
print(datafiles)

setwd("/Users/amyw/Documents/QBS103/DSProject")

for (file in datafiles){
  the_file <- read.csv(file)
}
  
setwd("/Users/amyw/Documents/QBS103/DSProject")

gene_df <- read.csv('QBS103_GSE157103_genes.csv', header = TRUE,row.names = 1)
meta_df <- read.csv('QBS103_GSE157103_series_matrix.csv', header = TRUE, row.names = 1)

working_genes <- as.data.frame(t(gene_df)) #pivoting dataframe to select AAGAB as a column
#print(head(working_genes))

new_comp <- merge(working_genes, meta_df, by = 'row.names') #merging the two dataframes using the row names
final_comp <- data.frame(new_comp, row.names = 1) #renaming the row names as the participant ID


final_comp$mechanical_ventilation <- replace(final_comp$mechanical_ventilation, final_comp$mechanical_ventilation == ' yes', 'Yes')
final_comp$mechanical_ventilation <- replace(final_comp$mechanical_ventilation, final_comp$mechanical_ventilation == ' no', 'No')

final_comp$icu_status <- replace(final_comp$icu_status, final_comp$icu_status == ' yes', 'Yes')
final_comp$icu_status <- replace(final_comp$icu_status, final_comp$icu_status == ' no', 'No')

final_comp$sex <- replace(final_comp$sex, final_comp$sex == ' female', 'Female')
final_comp$sex <- replace(final_comp$sex, final_comp$sex == ' male', 'Male')
print(head(final_comp))

```

```{r}
#-----------------------SEPARATING BY CAT VARIABLE------------------------
ventData <- data.frame(final_comp[final_comp$mechanical_ventilation == 'Yes', ])
nonventData <- data.frame(final_comp[final_comp$mechanical_ventilation == 'No', ])

#-------------------GETTING INDEX NUMBERS FOR CONT VARIABLES----------------------
contVars <- c('age', 'lactate.mmol.l.', 'fibrinogen')
contVarsIndex <- list()

for (i in 1:length(final_comp)) {
  for (j in 1:length(contVars)) {
    if (colnames(final_comp)[i] == contVars[j])
      print(paste('Index for', contVars[j] ,'is', i))
      contVarsIndex <- append(contVarsIndex, i)
    }
}
contVarsIndex = c(110, 122, 123)


#-----------------------------CHECKING DISTRIBUTION--------------------
for (index in contVarsIndex){
  #checking distribution
  xAxis = 0
  
  if (colnames(final_comp[index]) == 'age'){
    xAxis <- 'Age'
    # print(xAxis)
  }

  else if (colnames(final_comp[index]) == 'lactate.mmol.l.'){
    xAxis <- 'Lactate (mmol/l)'
    # print(xAxis)
  }
  else {#(colnames(final_comp[index]) == 'fibrinogen'){
    xAxis <- 'Fibrinogen'
    # print(xAxis)
  }

  final_comp[[index]]<- as.numeric(final_comp[[index]])
  
  plot<- ggplot(data = final_comp,aes(x = final_comp[[index]])) +
                geom_histogram() + 
                labs(x = xAxis, y = 'Frequency') +
                theme_classic()
  print(plot)

}
```

```{r}
#-----------------PART 1: VALUES FOR CONT VAR FOR VENTILATED PATIENTS--------------

#lactate non uniformly distributed
ventData$lactate.mmol.l. <- as.double(ventData$lactate.mmol.l.)
ventData$age <- as.double(ventData$age)
ventData$fibrinogen <- as.double(ventData$fibrinogen)



medVar <- median(ventData$lactate.mmol.l., na.rm = TRUE)
# Quartile values
quantileVar <- quantile(ventData[122], na.rm = TRUE)
  
# IQR (Q3 - Q1)
IQRVar <- IQR(ventData$lactate.mmol.l., na.rm = TRUE)
  
lowerQua <- quantile(ventData$lactate.mmol.l., 1/4, na.rm = TRUE)
  
higherQua <- quantile(ventData$lactate.mmol.l., 3/4, na.rm = TRUE)
  
#print median and IQR statement
print(paste('Median [IQR] of lactate of age in ventilated patients:',round((medVar),digits = 2),
             '[',round((lowerQua), digits = 2), ',', round((higherQua), digits = 2),']'))


#for age and fibrinogen which are uniformly distributed
print(paste('Mean (sd) of age in ventilated patients: ',round(mean(ventData$age),digits = 2),' (',
             round(sd(ventData$age),digits = 2),')'))


print(paste('Mean (sd) of fibrinogen in ventilated patients: ',round(mean(ventData$fibrinogen, na.rm=TRUE),digits = 2),' (',
             round(sd(ventData$fibrinogen, na.rm=TRUE),digits = 2),')'))


```


```{r}
#-----------------PART 1: VALUES FOR CONT VAR FOR NONVENTILATED PATIENTS--------------

nonventData$lactate.mmol.l. <- as.double(nonventData$lactate.mmol.l.)
nonventData$age <- as.double(nonventData$age)
nonventData$fibrinogen <- as.double(nonventData$fibrinogen)

#lactate non uniformly distributed
nonventData$lactate.mmol.l. <- as.double(nonventData$lactate.mmol.l.)

medVar <- median(nonventData$lactate.mmol.l., na.rm = TRUE)
# Quartile values
quantileVar <- quantile(nonventData$lactate.mmol.l., na.rm = TRUE)
  
# IQR (Q3 - Q1)
IQRVar <- IQR(nonventData$lactate.mmol.l., na.rm = TRUE)
  
lowerQua <- quantile(nonventData$lactate.mmol.l., 1/4, na.rm = TRUE)
  
higherQua <- quantile(nonventData$lactate.mmol.l., 3/4, na.rm = TRUE)
  
#print median and IQR statement
print(paste('Median [IQR] of lactate in non-ventilated patients:',round((medVar),digits = 2),
             '[',round((lowerQua), digits = 2), ',', round((higherQua), digits = 2),']'))


#for age and fibrinogen which are uniformly distributed
nonventData$age <- as.double(nonventData$age)
nonventData$fibrinogen <- as.double(nonventData$fibrinogen)


print(paste('Mean (sd) of age in non-ventilated patients: ',round(mean(nonventData$age, na.rm=TRUE),digits = 2),' (',
             round(sd(nonventData$age, na.rm=TRUE),digits = 2),')'))

print(paste('Mean (sd) of fibrinogen in non-ventilated patients: ',round(mean(nonventData$fibrinogen, na.rm=TRUE),digits = 2),' (',
             round(sd(nonventData$fibrinogen, na.rm=TRUE),digits = 2),')'))

```

```{r}
#-------------------PART 1: CATEGORICAL DATA---------------------------------
data.frame('n' = c(table(ventData$sex)),
          'percent' = c(round(table(ventData$sex)/(length(ventData$sex))*100,digits = 2)))


data.frame('n' = c(table(nonventData$sex)),
          'percent' = c(round(table(nonventData$sex)/(length(nonventData$sex))*100,digits = 2)))

#--------------- PART 1: for ICU status------------------------
data.frame('n' = c(table(ventData$icu_status)),
          'percent' = c(round(table(ventData$icu_status)/(length(ventData$icu_status))*100,digits = 2)))


data.frame('n' = c(table(nonventData$icu_status)),
          'percent' = c(round(table(nonventData$icu_status)/(length(nonventData$icu_status))*100,digits = 2)))
```


```{r}
#------------------------GENERATING TABLE 1-----------------------------
#https://einsteinmed.edu/uploadedfiles/centers/ictr/new/p3-r4-table-1-package-in-r.pdf
#https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html


table1Data <- data.frame(final_comp$mechanical_ventilation, #stratifying
                         final_comp$lactate.mmol.l., 
                         final_comp$age, 
                         final_comp$fibrinogen,
                         final_comp$sex, #categorical
                         final_comp$icu_status) #categorical
head(table1Data)
colnames(table1Data) = c('mech_vent', 'Lactate','Age','Fibrinogen','Sex','icu_status')
table1Data$Lactate <- as.numeric(table1Data$Lactate)
table1Data$Age <- as.numeric(table1Data$Age)
table1Data$Fibrinogen <- as.numeric(table1Data$Fibrinogen)


table1Data$mech_vent <- 
  factor(table1Data$mech_vent, 
         levels=c('No','Yes'),
         labels=c("No Mechanical Ventilation", # Reference
                  "Mechanical Ventilation"))

table1Data$icu_status <- 
  factor(table1Data$icu, 
         levels=c('No','Yes'),
         labels=c("No ICU stay", # Reference
                  "ICU"))


#https://stackoverflow.com/questions/73965608/remove-the-mean-row-from-table1-function-in-r
#https://github.com/benjaminrich/table1/issues/126


label(table1Data$Age) <- "Age (years)"
label(table1Data$Lactate) <- "Lactate (mmol/l)"
label(table1Data$Fibrinogen) <- "Fibrinogen"
label(table1Data$Sex) <- "Sex"
label(table1Data$icu_status) <- "ICU Status"

table1(~ table1Data$Age+ 
         table1Data$Lactate+ 
         table1Data$Fibrinogen+
         table1Data$Sex+
         table1Data$icu_status| table1Data$mech_vent, data=table1Data, render.continuous=c(.="Median [Q1 &ndash; Q3]"))


```


```{r}
#----------------------------PART 2: HISTOGRAM OF AAGAB--------------------------
#plotting histogram of AAGAB
working_genes <- as.data.frame(t(gene_df)) #pivoting dataframe to select AAGAB as a column
print(head(working_genes))

ggplot(working_genes, aes(x=AAGAB))+
  geom_histogram(binwidth = 2, boundary = 0)+ #boundary at 0 to group data
  labs(title = 'Distribution of AAGAB', x = 'Expression of AAGAB', y = 'Frequency')+
  theme_light()+
  theme(plot.title = element_text(hjust=0.5),
        text = element_text(family = "serif")) #changing the font

new_comp <- merge(working_genes, meta_df, by = 'row.names') #merging the two dataframes using the row names
final_comp <- data.frame(new_comp, row.names = 1) #renaming the row names as the participant ID
print(head(final_comp))


final_comp$age<- as.numeric(final_comp$age) #converting the age column from characters to numerics


#--------------------------PART 2: SCATTERPLOT OF AAGAB--------------------------
ggplot(final_comp, aes(x= age, y=AAGAB))+
  geom_point()+ #two age unknowns from the data
  labs(title = 'Age Compared to Distribution of Gene AAGAB', 
       x = 'Age (years)', y = 'Expression of AAGAB')+
  scale_x_continuous(breaks=seq(0,150,by=10))+
  theme_light()+
  theme(plot.title = element_text(hjust=0.5),
         text = element_text(family = "serif"))


#----------------------------PART 2: BOXPLOT OF AAGAB--------------------------
ggplot(final_comp, aes (sex, AAGAB, fill = mechanical_ventilation))+
  geom_boxplot()+
  theme_light()+
  labs(title = 'Distribution of AAGAB Based on Sex Coloured by Mechanical Ventilation', 
       x = 'Sex', y = 'Expression of AAGAB')+
  theme(plot.title = element_text(hjust=0),
        text = element_text(family = "serif"))+
  scale_fill_discrete(name = 'Mechanical Ventilation Status')+
  scale_x_discrete(labels = c('Female', 'Male', 'Unknown'))
```


```{r}
#------------------------------PART 3: HEATMAP

annotationData <- data.frame(Sex = final_comp$sex,'ICU Status' = final_comp$icu_status)

rownames(annotationData) <- rownames(final_comp)



annotationColors <- list(sex= c(' male' = 'aquamarine4',
                                   ' female' = 'purple4',
                                   ' unknown' = 'red'),
                            icu_status = c(' yes' = 'yellow',
                                           ' no' = 'pink'))

f2 <-data.frame(final_comp[,15:25])
rownames(f2) = rownames(final_comp)
# Generate heatmap
pheatmap(f2,
         show_rownames = F,
         cluster_rows = T,
         cluster_cols = T,
         clustering_distance_cols = 'euclidean',
         clustering_distance_rows = 'euclidean',
         annotation_row = annotationData,
         annotation_colors = annotationColors,
         main = 'Heatmap',
         #legend = TRUE,
         legend_labels = c('ICU Status','Sex'),
         annotation_legend = T)

#https://stackoverflow.com/questions/36852101/r-legend-title-or-units-when-using-pheatmap


```



```{r}
#---------------PART 3: NEW PLOT TYPE-------------------------------
plotData <- data.frame(final_comp['AAGAB'], final_comp['mechanical_ventilation'])

nonventPlot <- data.frame(plotData[plotData$mechanical_ventilation == ' no', ])
ventPlot <- data.frame(plotData[plotData$mechanical_ventilation == ' yes', ])

head(plotData)


#, binwidth = 5, boundary = 0
ggplot()+
  geom_freqpoly(data= nonventData, mapping = aes(x=AAGAB), colour = 'red', binwidth = 5, boundary = 0)+
  geom_freqpoly(ventData, mapping = aes(x=AAGAB), colour = 'blue', binwidth = 5, boundary = 0)+#boundary at 0 to group data
  labs(title = 'Distribution of AAGAB Based on Mechanical Ventilation Status', x = 'Expression of AAGAB', y = 'Frequency')+
  theme_light()+
  theme(plot.title = element_text(hjust=0.5))

```
Introduction
With the spread of COVID-19, there were few studies that examined that molecular-level response to the COVID-19 virus. The study "Large-Scale Multi-omic Analysis of COVID-19 Severity" applied RNA-seq and high resolution mass spectrometry on 128 blood samples from COVID positive and negative patients. The objective of this study was to assess the key molecular markers of the  COVID-19 response, associate these markers with clinical metadata and outcome, and generate new hypotheses.
Blood samples were collected from these 128 patients with moderate to severe respiratory issues between April 6, 2020 and May 1, 2020 from Albany Medical Center in Albany, NY. There were 219 molecular features identified that were significant to COVID status, many that were important in various disease processes related to COVID-19.
For the analysis pertaining to this report, the gene AAGAB was studied. AAGAB, or alpha and gamma adaptin binding protein, is a protein coding gene in humans that encodes for proteins that interact with "subunits of complexes involved in clathrin-coated vesicle tracking". AAGAB is expressed throughout the body in the thyroid, colon, and 25 other tissues.  

Methods
Data source, methods for data collection and analysis can be found in the study (CITE).Blood samples were collected from these 128 patients with moderate to severe respiratory issues between April 6, 2020 and May 1, 2020 from Albany Medical Center in Albany, NY. There were 219 molecular features identified that were significant to COVID status, many that were important in various disease processes related to COVID-19. 

For the purposes of this report, R version 4.2 was used in conjunction with the pheatmap, tidyverse, dplyr, ggplot2, rlang, corrplot, and table1 packages to analyze and visualize the data and relationship between variables. The clustering algorithm used to (FINISH)  

Results
difference in plots: ABI1, ABHD5

References
https://stats.stackexchange.com/questions/280589/how-to-effectively-visualize-multiple-frequency-polygons-in-ggplot2



